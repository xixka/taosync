build-termux:
  name: Termux多平台构建
  runs-on: ubuntu-latest
  needs: [ get-version, build-frontend ]
  env:
    VERSION: ${{ needs.get-version.outputs.VERSION }}
  strategy:
    matrix:
      platform: [ "arm64", "arm32" ]
          
  steps:
    - name: 检出仓库代码
      uses: actions/checkout@v4

    - name: 下载前端
      uses: actions/download-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist

    - name: 设置QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: all

    - name: 设置目标平台变量
      id: set-platform
      run: |
        case "${{ matrix.platform }}" in
          arm64)   TERMUX_TAG="aarch64" ;;
          arm32)   TERMUX_TAG="arm" ;;
        esac
        echo "TERMUX_TAG=$TERMUX_TAG" >> $GITHUB_ENV
        echo "TARGET_PLATFORM=${{ matrix.platform }}" >> $GITHUB_ENV
            
    - name: 在Termux Docker容器中构建
      run: |
        docker run --rm --privileged \
          -v "$(pwd):/app" \
          -w /app \
          -e APP_NAME=${{ env.APP_NAME }} \
          -e TARGET_PLATFORM=${{ env.TARGET_PLATFORM }} \
          termux/termux-docker:$TERMUX_TAG \
          sh -c '
            set -e
            
            # 关键修复：强制刷新仓库并修复python安装
            pkg update -y && pkg upgrade -y
            pkg install -y python python-pip build-essential zlib libffi openssl-tool
            
            # 修复pip配置冲突
            rm -f /data/data/com.termux/files/usr/etc/pip.conf
            
            # 重新安装pip（解决模块缺失问题）
            python -m ensurepip --upgrade
            pip install --upgrade pip setuptools wheel
            
            # 安装编译依赖
            pip install "pyinstaller>=6,<7"
            pip install -r requirements.txt
            
            # 执行构建
            python -m PyInstaller "$APP_NAME.spec" \
              --distpath "/app/dist/$TARGET_PLATFORM" \
              --workpath "/app/build/$TARGET_PLATFORM"
          '
      
    - name: 打包为tar.gz
      run: |
        tar -czf "taoSync-termux-${{ env.TARGET_PLATFORM }}.tar.gz" -C "dist/${{ env.TARGET_PLATFORM }}" .
              
    - name: 上传artifact
      uses: actions/upload-artifact@v4
      with:
        name: taoSync-termux-${{ env.TARGET_PLATFORM }}
        path: taoSync-termux-${{ env.TARGET_PLATFORM }}.tar.gz
        retention-days: 1
